<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de horarios</title>
    <link rel="icon" type="image/png" href="./assets/Schedule FI Yellow (1).png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap');
        :root{
            --color-yellow: #FCB814;
            --color-black: #221F20;
            --color-cerulean: #3D7B93;
            --color-dim-gray: #636466;
            --color-tomato: #F26649;
            --color-celadon: #81C99C;
            --color-gray-olive: #939598;
            --color-soft-periwinkle: #8781BD;
            --font-roboto-mono: "Roboto Mono", monospace;
            --font-size-lg : 10rem;
            --font-size-md : 5rem;
            --font-size-sm : 2rem;
            --font-size-xsm : 1rem;
        }
        body{
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 0;
            margin: 0;
        }

        header{
            width: 100%;
            height: 7dvh;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: var(--color-yellow);
            border: solid 1px;
            border-color: none none var(--color-black) none;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        header nav{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem 0 2rem;
            margin: 0;
            box-sizing: border-box;
        }

        header nav ul{
            width: auto;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: row;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        header nav ul a{
            text-decoration: none;
            width: auto;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: var(--font-size-sm);
            color: var(--color-black);
            font-family: var(--font-roboto-mono);
            font-weight: bold;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        header nav ul:last-child a:first-child{
            height: 100%;
            box-shadow: inset 0 -5px 0 0 var(--color-black);
            background-color: transparent;
        }

        header nav ul a:nth-child(2){
            width: auto;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0 0 0 2rem;
        }

        header a img{
            width: auto;
            height: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        main{
            width: 100%;
            height: 93dvh;
            display: grid;
            grid-template-rows: repeat(10, 1fr);
            grid-template-columns: repeat(13, 1fr);
            background-color: var(--color-yellow);
            padding: 0;
            margin: 0;
        }

        main button{
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--color-yellow);
            text-decoration: none;
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-black);
            font-weight: bold;
            border-radius: 1rem;
            border: solid 5px var(--color-black);
            cursor: pointer;
            padding: 0;
            margin: 0;
        }


        main button:hover{
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--color-black);
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-yellow);
            font-weight: bold;
            border-radius: 1rem;
            border: solid 3px var(--color-black);
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        main a{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 5/2/7/5;
            text-decoration: none;
            display: inline-block;
            color: inherit;
        }

        main a button{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 5/2/7/5;
            border: solid 5px var(--color-black);
            text-decoration: none;
            display: inline-block;
            color: inherit;
        }

        main input{
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        main label{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 5/6/7/9;
            background-color: var(--color-yellow);
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-black);
            text-align: center;
            font-weight: bold;
            border-radius: 1rem;
            border: solid 5px var(--color-black);
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        main label:hover{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 5/6/7/9;
            background-color: var(--color-black);
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-yellow);
            text-align: center;
            font-weight: bold;
            border-radius: 1rem;
            border: solid 3px var(--color-black);
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        .button_accion{
            grid-area: 5/10/7/13;
        }

        .span_error{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 8/2/9/13;
            font-size: var(--font-size-sm);
            text-align: center;
            color: var(--color-black);
            font-weight: bold;
        }

        footer{
            width: 100%;
            height: 30dvh;
            background-color: var(--color-black);
        }

    </style>

</head>
<body>

    <header>
        <nav>
            <ul>
                <a href="index.html"><img src="assets/ICON-BRUTO-FI-BLACK.png" alt="LOGO"></a>
            </ul>
            <ul>
                <a href="./index.html">Generador</a>
                <a href="./manual.html">Manual</a>
            </ul>
        </nav>
        
    </header>

    <main>
        <a href="./plantillaDatos.xlsx">
            <button class="button_plantilla" id="button_plantilla">Descargar plantilla</button>
        </a>
        <input class="input_excel" id="input_excel" type="file">
        <label for="input_excel" class="custom-button">
            <span>Seleccionar archivo</span>
        </label>
        <button class="button_accion" id="button_accion">Generar horarios</button>
        
        <div class="span_error" id="span_error"></div>
    </main>

    <footer>

    </footer>

    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <script>
        const diasSemana = ["lunes", "martes", "miercoles", "jueves", "viernes", "sabado"];
        let MAPA_DOCENTES = new Map();
        let MAPA_GRUPOS = new Map();
        let PLANTILLAS_MATERIAS = [];
        let ERRORES = [];

        const esTutoria = (n) => n.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes("TUTORIA");

        class Materia {
    constructor(nombre, horas, grado, turno, tsu) {
        this.nombre_materia = nombre;
        this.horas_materia = parseInt(horas);
        this.grado_materia = grado;
        this.turno_materia = turno;
        this.tsu_materia = tsu;
        this.docente = null;
        this.grupo = null;
        this.desglose_horas = {};
    }

    determinar_horas_clase_por_materia() {
        if (!this.docente) return;
        const tipo = this.docente.tipo_docente;
        const horas = this.horas_materia;
        const cargaTotalReal = this.docente.horas_carga + this.docente.horas_extra_clase;
        const d = this.desglose_horas = {};
        const nombreM = this.nombre_materia.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

        if (nombreM.includes("INGLES")) {
            for (let i = 1; i <= horas; i++) d[`h${i}`] = 1;
            return;
        }

        // --- ORDEN CORREGIDO ---

        // 1. TIPO 1 CON CARGA MUY BAJA (Máximo 2 sesiones para que no se parta tanto)
        if (tipo === 1 && cargaTotalReal <= 6) {
            if (horas === 6) { d.h1 = 3; d.h2 = 3; }
            else if (horas === 5) { d.h1 = 3; d.h2 = 2; }
            else if (horas === 4) { d.h1 = 2; d.h2 = 2; }
            else if (horas === 3) { d.h1 = 2; d.h2 = 1; }
            else if (horas === 2) { d.h1 = 1; d.h2 = 1; }
            else { d.h1 = 1; }
        }
        // 2. TIPO 2 CON CARGA BAJA (< 10h) -> 2 Sesiones bloques largos
        else if (tipo === 2 && cargaTotalReal < 10) {
            if (horas === 7) { d.h1 = 4; d.h2 = 3; }
            else if (horas === 6) { d.h1 = 3; d.h2 = 3; }
            else if (horas === 5) { d.h1 = 3; d.h2 = 2; }
            else if (horas === 4) { d.h1 = 2; d.h2 = 2; }
            else if (horas === 3) { d.h1 = 2; d.h2 = 1; }
            else if (horas === 2) { d.h1 = 1; d.h2 = 1; }
            else { d.h1 = 1; }
        }
        // 3. TIPO 1 (Carga > 6) o TIPO 2 (Carga entre 10 y 19h) -> 3 Sesiones
        else if (tipo === 1 || (tipo === 2 && cargaTotalReal >= 10 && cargaTotalReal <= 19)) {
            if (horas === 7) { d.h1 = 3; d.h2 = 2; d.h3 = 2; }
            else if (horas === 6) { d.h1 = 2; d.h2 = 2; d.h3 = 2; }
            else if (horas === 5) { d.h1 = 2; d.h2 = 2; d.h3 = 1; }
            else if (horas === 4) { d.h1 = 2; d.h2 = 2; }
            else if (horas === 3) { d.h1 = 2; d.h2 = 1; }
            else if (horas === 2) { d.h1 = 1; d.h2 = 1; }
            else { d.h1 = 1; }
        }
        // 4. CARGA ALTA O OTROS (Tipo 2 >= 20h, Tipo 3, PTC) -> 4 Sesiones
        else { 
            if (horas === 7) { d.h1 = 2; d.h2 = 2; d.h3 = 2; d.h4 = 1; }
            else if (horas === 6) { d.h1 = 2; d.h2 = 2; d.h3 = 2; }
            else if (horas === 5) { d.h1 = 2; d.h2 = 1; d.h3 = 1; d.h4 = 1; }
            else if (horas === 4) { d.h1 = 2; d.h2 = 1; d.h3 = 1; }
            else if (horas === 3) { d.h1 = 1; d.h2 = 1; d.h3 = 1; }
            else if (horas === 2) { d.h1 = 1; d.h2 = 1; }
            else { d.h1 = 1; }
        }
    }
}

        class Docente {
            constructor(nombre, fila, tipo, horas_extra) {
                this.nombre_docente = nombre.trim();
                this.fila = fila;
                this.tipo_docente = parseInt(tipo);
                this.horas_extra_clase = parseInt(horas_extra) || 0;
                this.materias_impartidas = [];
                this.horas_carga = 0;
                this.reset();
            }
            reset() {
                diasSemana.forEach(dia => this[`lista_${dia}`] = this.parseDisp(this.fila[dia]));
                this.diasActivosGlobal = new Set();
            }
            parseDisp(str) {
                if (!str || str === "-") return [];
                let h = [];
                String(str).split(" ").forEach(r => {
                    const [i, f] = r.split("-").map(Number);
                    for (let j = i; j < f; j++) h.push(j);
                });
                return h;
            }
        }

        class Grupo {
            constructor(nombre, turno) {
                this.nombre_grupo = nombre.trim();
                this.turno = turno.toLowerCase();
                this.materias = [];
                this.reset();
            }
            reset() {
                const base = (this.turno === "matutino") ? [7,8,9,10,11,12,13,14,15,16,17] : [11,12,13,14,15,16,17,18,19,20];
                diasSemana.forEach(dia => this[`horario_${dia}`] = [...base]);
            }
        }

        document.getElementById("input_excel").addEventListener("change", (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                MAPA_DOCENTES.clear(); MAPA_GRUPOS.clear(); PLANTILLAS_MATERIAS = [];
                const rawM = XLSX.utils.sheet_to_json(wb.Sheets["Materias"]);
                PLANTILLAS_MATERIAS = rawM.map(m => new Materia(m.nombre, m.horas, m.grado, m.tirno || m.turno, m.tsu));
                const rawD = XLSX.utils.sheet_to_json(wb.Sheets["Docentes"]);
                rawD.forEach(d => {
                    const extra = d['horas extra clase'] || d['estadia'] || 0;
                    MAPA_DOCENTES.set(d.nombre.trim(), new Docente(d.nombre, d, d.tipo, extra));
                });
                const rawG = XLSX.utils.sheet_to_json(wb.Sheets["Grupos"]);
                rawG.forEach(g => MAPA_GRUPOS.set(g.nombre.trim(), new Grupo(g.nombre, g.turno)));
                const rawA = XLSX.utils.sheet_to_json(wb.Sheets["Asignaciones"]);
                rawA.forEach(asig => {
                    const g = MAPA_GRUPOS.get(String(asig.grupo).trim());
                    const d = MAPA_DOCENTES.get(String(asig.docente).trim());
                    const p = PLANTILLAS_MATERIAS.find(m => m.nombre_materia === asig.materia);
                    if (g && d && p) {
                        const c = new Materia(p.nombre_materia, p.horas_materia, p.grado_materia, p.turno_materia, p.tsu_materia);
                        c.grupo = g; c.docente = d;
                        g.materias.push(c); d.materias_impartidas.push(c);
                        d.horas_carga += c.horas_materia;
                    }
                });
                alert("Excel cargado.");
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function algoritmoGenerar() {
            ERRORES = [];
            MAPA_GRUPOS.forEach(g => g.reset());
            MAPA_DOCENTES.forEach(d => d.reset());
            
            const listaOrdenada = Array.from(MAPA_DOCENTES.values()).sort((a, b) => {
                const dA = diasSemana.reduce((s, dia) => s + a[`lista_${dia}`].length, 0);
                const dB = diasSemana.reduce((s, dia) => s + b[`lista_${dia}`].length, 0);
                const cargaA = a.horas_carga + a.horas_extra_clase;
                const cargaB = b.horas_carga + b.horas_extra_clase;
                const sA = (dA / (cargaA || 1)) * a.tipo_docente;
                const sB = (dB / (cargaB || 1)) * b.tipo_docente;
                a.score_p = sA; b.score_p = sB;
                return sA - sB;
            });

            console.log("%c PRIORIDAD DOCENTES ", "background: #222; color: #FCB814; font-weight: bold;");
            console.table(listaOrdenada.map(d => ({ 
                "Nombre": d.nombre_docente, 
                "Carga Total": d.horas_carga + d.horas_extra_clase,
                "Score": d.score_p.toFixed(4) 
            })));

            listaOrdenada.forEach(docente => {
                docente.materias_impartidas.sort((a,b) => esTutoria(a.nombre_materia) - esTutoria(b.nombre_materia));
                docente.materias_impartidas.forEach(materia => {
                    materia.determinar_horas_clase_por_materia();
                    let sesiones = Object.entries(materia.desglose_horas).map(([id, tam]) => ({ id, tam }));
                    let diasMatLocal = new Set();

                    while (sesiones.length > 0) {
                        let opciones = [];
                        const esVesp = materia.grupo.turno === "vespertino";
                        const cT = docente.horas_carga + docente.horas_extra_clase;
                        let minD = 0, maxD = 6;
                        
                        if (docente.tipo_docente === 2) {
                            if (cT <= 9) { maxD = 2; minD = 2; }
                            else if (cT <= 19) { maxD = 3; minD = 3; }
                            else { maxD = 4; minD = 4; } // Aquí entra el de 20h
                        }

                        diasSemana.forEach(dia => {
                            if (diasMatLocal.has(dia) && docente.tipo_docente !== 1) return;
                            if (docente.tipo_docente === 2 && docente.diasActivosGlobal.size >= maxD && !docente.diasActivosGlobal.has(dia)) return;
                            
                            const hG = materia.grupo[`horario_${dia}`], hD = docente[`lista_${dia}`];
                            const reales = hG.filter(h => typeof h === 'number' && hD.includes(h));
                            if (reales.length === 0) return;

                            let bloques = [], curr = [reales[0]];
                            for(let i=1; i<=reales.length; i++){
                                if(reales[i] === reales[i-1]+1) curr.push(reales[i]);
                                else { bloques.push(curr); if(reales[i]) curr=[reales[i]]; }
                            }

                            bloques.forEach(b => {
                                sesiones.forEach(s => {
                                    if(s.tam <= b.length) {
                                        const hSel = esVesp ? b.slice(-s.tam) : b.slice(0, s.tam);
                                        
                                        let penalizacionContinuidad = 0;
                                        if (docente.tipo_docente === 1 || (docente.tipo_docente === 2 && cT >= 10)) {
                                            const hAnterior = hSel[0] - 1;
                                            const hSiguiente = hSel[hSel.length - 1] + 1;
                                            const contenidoDia = materia.grupo[`horario_${dia}`];
                                            
                                            const yaHayMateria = contenidoDia.some(h => typeof h === 'string' && h.includes(materia.nombre_materia));
                                            if (yaHayMateria) {
                                                const esContiguo = (typeof contenidoDia.find((_, idx) => idx + 7 === hAnterior) === 'string') ||
                                                                   (typeof contenidoDia.find((_, idx) => idx + 7 === hSiguiente) === 'string');
                                                if (esContiguo) penalizacionContinuidad = 100; 
                                            }
                                        }

                                        opciones.push({ 
                                            dia, horas: hSel, tam: s.tam, id: s.id, hI: hSel[0], 
                                            esNuevo: !docente.diasActivosGlobal.has(dia), 
                                            disp: reales.length,
                                            penalizacion: penalizacionContinuidad
                                        });
                                    }
                                });
                            });
                        });

                        if (opciones.length > 0) {
                            opciones.sort((a, b) => {
                                if (a.penalizacion !== b.penalizacion) return a.penalizacion - b.penalizacion;
                                
                                if (docente.tipo_docente === 2 && docente.diasActivosGlobal.size < minD) {
                                    if (a.esNuevo !== b.esNuevo) return b.esNuevo - a.esNuevo;
                                    if (a.esNuevo) return b.disp - a.disp;
                                }
                                if (b.tam !== a.tam) return b.tam - a.tam;
                                return esVesp ? b.hI - a.hI : a.hI - b.hI;
                            });
                            
                            const m = opciones[0];
                            materia.grupo[`horario_${m.dia}`] = materia.grupo[`horario_${m.dia}`].map(h => m.horas.includes(h) ? `${materia.nombre_materia} (${docente.nombre_docente})` : h);
                            docente[`lista_${m.dia}`] = docente[`lista_${m.dia}`].map(h => m.horas.includes(h) ? { hv: h, txt: `${materia.nombre_materia} [${materia.grupo.nombre_grupo}]` } : h);
                            
                            diasMatLocal.add(m.dia); docente.diasActivosGlobal.add(m.dia);
                            sesiones = sesiones.filter(s => s.id !== m.id);
                        } else {
                            const idx = sesiones.findIndex(s => s.tam > 1);
                            if (idx !== -1) {
                                const s = sesiones.splice(idx, 1)[0];
                                sesiones.push({ id: s.id+'a', tam: 1 }, { id: s.id+'b', tam: s.tam-1 });
                            } else { ERRORES.push(`${materia.nombre_materia} (${docente.nombre_docente})`); break; }
                        }
                    }
                });
            });
            document.getElementById("span_error").innerText = ERRORES.length > 0 ? "⚠ No asignados: " + ERRORES.join(", ") : "✔ Generado correctamente.";
        }

        document.getElementById("button_accion").addEventListener("click", () => {
            if (MAPA_DOCENTES.size === 0) return alert("Carga datos.");
            algoritmoGenerar();
            const wb = XLSX.utils.book_new();
            MAPA_GRUPOS.forEach(g => {
                const rows = [["HORA", "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"]];
                const base = (g.turno === "matutino") ? [7,8,9,10,11,12,13,14,15,16,17] : [11,12,13,14,15,16,17,18,19,20];
                base.forEach((h, i) => {
                    rows.push([ h, typeof g.horario_lunes[i] === "string" ? g.horario_lunes[i] : "", typeof g.horario_martes[i] === "string" ? g.horario_martes[i] : "", typeof g.horario_miercoles[i] === "string" ? g.horario_miercoles[i] : "", typeof g.horario_jueves[i] === "string" ? g.horario_jueves[i] : "", typeof g.horario_viernes[i] === "string" ? g.horario_viernes[i] : "", typeof g.horario_sabado[i] === "string" ? g.horario_sabado[i] : "" ]);
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "G_" + g.nombre_grupo.substring(0,25));
            });
            MAPA_DOCENTES.forEach(d => {
                const rows = [["HORA", "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"]];
                for(let h=7; h<=21; h++) {
                    const f = [h];
                    diasSemana.forEach(dia => {
                        const found = d[`lista_${dia}`].find(item => item.hv === h);
                        f.push(found ? found.txt : "");
                    });
                    rows.push(f);
                }
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "D_" + d.nombre_docente.substring(0,25));
            });
            XLSX.writeFile(wb, "Horarios_LAGE.xlsx");

        });

        console.log("Lista de Prioridad:", listaOrdenada);
    </script>
</body>
</html>