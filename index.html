<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de horarios</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap');
        :root{
            --color-yellow: #FCB814;
            --color-black: #221F20;
            --font-roboto-mono: "Roboto Mono", monospace;
            --font-size-lg : 10rem;
            --font-size-md : 5rem;
            --font-size-sm : 2rem;
            --font-size-xsm : 1rem;
        }

        body{
            width: 100%;
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 0;
            margin: 0;
        }

        header{
            width: 100%;
            height: 8%;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            background-color: var(--color-black);
            padding: 0;
            margin: 0;
        }

        header nav{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-black);
            padding: 0 2rem 0 2rem;
            margin: 0;
        }

        header nav ul{
            width: auto;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: row;
            background-color: var(--color-black);
            padding: 0;
            margin: 0;
        }

        header nav ul a{
            width: auto;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            text-decoration: underline;
            font-size: var(--font-size-sm);
            color: var(--color-yellow);
            font-family: var(--font-roboto-mono);
            padding: 0;
            margin: 0;
        }

        header nav ul a:nth-child(2){
            width: auto;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0 0 0 2rem;
        }

        header a img{
            width: 3rem;
            height: 3rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        main{
            width: 100%;
            height: 92%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: var(--color-yellow);
            padding: 0;
            margin: 0;
        }

        main button{
            width: 22rem;
            height: 7rem;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--color-yellow);
            text-decoration: none;
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-black);
            font-weight: bold;
            border-radius: 1rem;
            border: solid 3px var(--color-black);
            cursor: pointer;
            padding: 0;
            margin: 0;
        }


        main button:hover{
            width: 22rem;
            height: 7rem;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--color-black);
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-yellow);
            font-weight: bold;
            border-radius: 1rem;
            border: solid 3px var(--color-black);
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        main a{
            text-decoration: none;
            display: inline-block;
            color: inherit;
        }

        main input{
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        main label{
            width: 22rem;
            height: 7rem;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--color-yellow);
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-black);
            text-align: center;
            font-weight: bold;
            border-radius: 1rem;
            border: solid 3px var(--color-black);
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        main label:hover{
            width: 22rem;
            height: 7rem;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--color-black);
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-yellow);
            text-align: center;
            font-weight: bold;
            border-radius: 1rem;
            border: solid 3px var(--color-black);
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

    </style>

</head>
<body>

    <header>
        <nav>
            <ul>
                <a href="./index.html"><img src="./assets/ICON-BRUTO-FI-YELLOW.png" alt="LOGO"></a>
            </ul>
            <ul>
                <a href="./index.html">Generador</a>
                <a href="./manual.html">Manual</a>
            </ul>
        </nav>
        
    </header>

    <main>
        <a href="./plantillaDatos.xlsx">
            <button class="button_plantilla" id="button_plantilla">Descargar plantilla</button>
        </a>
        <input class="input_excel" id="input_excel" type="file">
        <label for="input_excel" class="custom-button">
            <span>Seleccionar archivo</span>
        </label>
        <button class="button_accion" id="button_accion">Generar horarios</button>
    </main>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <script>
        const button_accion = document.getElementById("button_accion");
        const input_excel = document.getElementById("input_excel");
        const diasSemana = ["lunes", "martes", "miercoles", "jueves", "viernes"];

        // --- CLASES DEL SISTEMA ---
        class Materia {
            constructor(nombre_materia, horas_materia, grado_materia, turno_materia, tsu_materia) {
                this.nombre_materia = nombre_materia;
                this.horas_materia = horas_materia;
                this.grado_materia = grado_materia;
                this.turno_materia = turno_materia;
                this.tsu_materia = tsu_materia;
                this.docente = null;
                this.grupo = null;
                this.desglose_horas = {};
                this.permiteFraccionar = false;
            }

            determinar_horas_clase_por_materia() {
                if (!this.docente) return;
                const tipo = this.docente.tipo_docente;
                const horas = this.horas_materia;
                const cargaTotal = this.docente.horas_carga;
                const d = this.desglose_horas = {};
                const nombreM = this.nombre_materia.toUpperCase();
                this.permiteFraccionar = (tipo >= 2);

                if (tipo === 1) { // INGLÉS
                    if (nombreM.includes("INGLES")) { for (let i = 1; i <= horas; i++) d[`h${i}`] = 1; } 
                    else {
                        if (horas === 3) { d.h1 = 2; d.h2 = 1; }
                        else if (horas === 2) { d.h1 = 1; d.h2 = 1; }
                        else { d.h1 = 1; }
                    }
                } else if (tipo === 2) { // PA
                    if (cargaTotal <= 9) {
                        if (horas === 7) { d.h1 = 4; d.h2 = 3; }
                        else if (horas === 6) { d.h1 = 3; d.h2 = 3; }
                        else { d.h1 = horas; }
                    } else {
                        let hRest = horas; let c = 1;
                        while(hRest > 0) { let b = (hRest >= 2) ? 2 : 1; d[`h${c}`] = b; hRest -= b; c++; }
                    }
                } else { // PTC/ADMIN
                    let hRest = horas; let c = 1;
                    while(hRest > 0) { let b = (hRest >= 2) ? 2 : 1; d[`h${c}`] = b; hRest -= b; c++; }
                }
            }

            asignarDocente(docente) {
                if (docente instanceof Docente) {
                    this.docente = docente;
                    docente.agregarMateria(this);
                }
            }
        }

        class Grupo {
            static lista_grupos_LAGE = [];
            static CONFIG_HORARIOS = {
                matutino: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17],
                vespertino: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
            };
            constructor(nombre_grupo, turno, listaMateriasPlantilla = []) {
                this.nombre_grupo = nombre_grupo;
                this.turno = turno.toLowerCase();
                const horasBase = Grupo.CONFIG_HORARIOS[this.turno] || [];
                diasSemana.concat(["sabado"]).forEach(dia => this[`horario_${dia}_grupo`] = [...horasBase]);
                this.materias = [];
                listaMateriasPlantilla.forEach(m => this.agregarMateria(m));
                Grupo.lista_grupos_LAGE.push(this);
            }
            agregarMateria(materia) {
                const clon = new Materia(materia.nombre_materia, materia.horas_materia, materia.grado_materia, materia.turno_materia, materia.tsu_materia);
                clon.grupo = this;
                this.materias.push(clon);
            }
            asignarDocenteAMateria(nombreM, docente) {
                const m = this.materias.find(mat => mat.nombre_materia === nombreM);
                if (m) m.asignarDocente(docente);
            }
        }

        class Docente {
            static lista_docentes = [];
            constructor(nombre, l, ma, mi, j, v, s, estadia, tipo) {
                this.nombre_docente = nombre;
                this.dispoinibilidad_lunes = l; this.dispoinibilidad_martes = ma; this.dispoinibilidad_miercoles = mi;
                this.dispoinibilidad_jueves = j; this.dispoinibilidad_viernes = v; this.dispoinibilidad_sabado = s;
                diasSemana.concat(["sabado"]).forEach(dia => {
                    this[`lista_horas_${dia}_docente`] = this.generarLista(this[`dispoinibilidad_${dia}`]);
                });
                this.tipo_docente = tipo; this.horas_carga = 0; this.materias_impartidas_docente = [];
                Docente.lista_docentes.push(this);
            }
            generarLista(str) {
                if (!str || str === "-") return [];
                let h = [];
                str.split(" ").forEach(r => {
                    const [ini, fin] = r.split("-").map(Number);
                    for (let i = ini; i < fin; i++) h.push(i);
                });
                return h;
            }
            agregarMateria(m) {
                if (!this.materias_impartidas_docente.includes(m)) {
                    this.materias_impartidas_docente.push(m);
                    this.horas_carga += m.horas_materia;
                }
            }
        }

        // --- LÓGICA DE CARGA DE EXCEL ---
        input_excel.addEventListener("change", (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Reiniciar listas
                Docente.lista_docentes = [];
                Grupo.lista_grupos_LAGE = [];

                // 1. Materias Plantilla
                const rawM = XLSX.utils.sheet_to_json(workbook.Sheets["Materias"]);
                const plantillas = rawM.map(m => new Materia(m.nombre, parseInt(m.horas), m.grado, m.turno || m.tirno, m.tsu));

                // 2. Docentes
                const rawD = XLSX.utils.sheet_to_json(workbook.Sheets["Docentes"]);
                rawD.forEach(d => new Docente(d.nombre, d.lunes, d.martes, d.miercoles, d.jueves, d.viernes, d.sabado, d.estadia, d.tipo));

                // 3. Grupos
                const rawG = XLSX.utils.sheet_to_json(workbook.Sheets["Grupos"]);
                rawG.forEach(g => new Grupo(g.nombre, g.turno));

                // 4. Asignaciones
                const rawA = XLSX.utils.sheet_to_json(workbook.Sheets["Asignaciones"]);
                rawA.forEach(asig => {
                    const g = Grupo.lista_grupos_LAGE.find(gr => gr.nombre_grupo === asig.grupo);
                    const d = Docente.lista_docentes.find(doc => doc.nombre_docente === asig.docente);
                    const p = plantillas.find(plan => plan.nombre_materia === asig.materia);
                    if (g && d && p) {
                        if (!g.materias.some(m => m.nombre_materia === asig.materia)) g.agregarMateria(p);
                        g.asignarDocenteAMateria(asig.materia, d);
                    }
                });
                alert("¡Excel cargado con éxito!");
            };
            reader.readAsArrayBuffer(file);
        });

        // --- FUNCIONES DE APOYO Y ALGORITMO ---
        const obtenerLibresReales = (g, d, dia) => {
            const hG = g[`horario_${dia}_grupo`];
            const hD = d[`lista_horas_${dia}_docente`];
            return hG.filter(h => typeof h === 'number' && hD.includes(h));
        };

        const asignarEspacio = (g, d, dia, horas, m) => {
            g[`horario_${dia}_grupo`] = g[`horario_${dia}_grupo`].map(h => horas.includes(h) ? `${m.nombre_materia} - ${d.nombre_docente}` : h);
            d[`lista_horas_${dia}_docente`] = d[`lista_horas_${dia}_docente`].map(h => horas.includes(h) ? { horaVal: h, texto: `${m.nombre_materia} - ${g.nombre_grupo}` } : h);
        };

        function calcularPrioridades() {
            Docente.lista_docentes.forEach(d => {
                let hDisp = diasSemana.reduce((acc, dia) => acc + d[`lista_horas_${dia}_docente`].length, 0);
                let dActivos = diasSemana.filter(dia => d[`lista_horas_${dia}_docente`].length > 0).length;
                d.prioridad = d.horas_carga > 0 ? (hDisp / d.horas_carga) * dActivos * d.tipo_docente : 999;
            });
            Docente.lista_docentes.sort((a, b) => a.prioridad - b.prioridad);
        }

        function crear_horarios() {
            Docente.lista_docentes.forEach(docente => {
                docente.materias_impartidas_docente.forEach(materia => {
                    materia.determinar_horas_clase_por_materia();
                    let sesiones = Object.entries(materia.desglose_horas).map(([id, tamano]) => ({ id, tamano }));
                    let diasOcupados = new Set();

                    while (sesiones.length > 0) {
                        let opciones = [];
                        diasSemana.forEach(dia => {
                            if (diasOcupados.has(dia) && docente.tipo_docente !== 1) return;
                            const libres = obtenerLibresReales(materia.grupo, docente, dia);
                            // Agrupar bloques contiguos
                            let bloques = []; if(libres.length === 0) return;
                            let curr = [libres[0]];
                            for(let i=1; i<=libres.length; i++){
                                if(libres[i] === libres[i-1]+1) curr.push(libres[i]);
                                else { bloques.push(curr); if(libres[i]) curr=[libres[i]]; }
                            }
                            bloques.forEach(b => {
                                sesiones.forEach(s => {
                                    if(s.tamano <= b.length) {
                                        opciones.push({ dia, horas: b.slice(0, s.tamano), tam: s.tamano, id: s.id });
                                    }
                                });
                            });
                        });

                        if (opciones.length > 0) {
                            opciones.sort((a, b) => b.tam - a.tam);
                            const mejor = opciones[0];
                            asignarEspacio(materia.grupo, docente, mejor.dia, mejor.horas, materia);
                            diasOcupados.add(mejor.dia);
                            sesiones = sesiones.filter(s => s.id !== mejor.id);
                        } else break;
                    }
                });
            });
        }

        // --- BOTÓN GENERAR ---
        button_accion.addEventListener("click", () => {
            if (Docente.lista_docentes.length === 0) return alert("Sube un archivo primero");
            calcularPrioridades();
            crear_horarios();
            descargar_documentos();
        });

        // --- EXPORTACIÓN ---
        function descargar_documentos() {
            const wbG = XLSX.utils.book_new();
            Grupo.lista_grupos_LAGE.forEach(g => {
                const data = [["HORA", "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES"]];
                Grupo.CONFIG_HORARIOS[g.turno].forEach((h, i) => {
                    data.push([h, 
                        typeof g.horario_lunes_grupo[i] === "number" ? "" : g.horario_lunes_grupo[i],
                        typeof g.horario_martes_grupo[i] === "number" ? "" : g.horario_martes_grupo[i],
                        typeof g.horario_miercoles_grupo[i] === "number" ? "" : g.horario_miercoles_grupo[i],
                        typeof g.horario_jueves_grupo[i] === "number" ? "" : g.horario_jueves_grupo[i],
                        typeof g.horario_viernes_grupo[i] === "number" ? "" : g.horario_viernes_grupo[i]
                    ]);
                });
                XLSX.utils.book_append_sheet(wbG, XLSX.utils.aoa_to_sheet(data), g.nombre_grupo.substring(0,31));
            });
            XLSX.writeFile(wbG, "Horarios_Grupos.xlsx");
        }
    </script>
</body>
</html>