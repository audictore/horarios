<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>From schedule</title>
    <link rel="icon" type="image/svg+xml" href="./assets/Schedule FI BLACK.svg">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap');
        :root{
            --color-yellow: #FCB814;
            --color-black: #221F20;
            --color-ghost-white: #F3F7FF;
            --color-cerulean: #3D7B93;
            --color-dim-gray: #636466;
            --color-tomato: #F26649;
            --color-celadon: #81C99C;
            --color-gray-olive: #939598;
            --color-soft-periwinkle: #8781BD;
            --font-roboto-mono: "Roboto Mono", monospace;
            --font-size-lg : 10rem;
            --font-size-md : 5rem;
            --font-size-sm : 2rem;
            --font-size-xsm : 1rem;
        }
        body{
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 0;
            margin: 0;
        }

        header{
            width: 100%;
            height: 7dvh;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: var(--color-yellow);
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        header nav{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem 0 2rem;
            margin: 0;
            box-sizing: border-box;
        }

        header nav ul{
            width: auto;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: row;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        header nav ul a{
            text-decoration: none;
            width: 5dvw;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: var(--font-size-xsm);
            color: var(--color-black);
            font-family: var(--font-roboto-mono);
            font-weight: bolder;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        header nav ul:last-child a:first-child{
            width: 5dvw;
            height: 100%;
            box-shadow: inset 0 -5px 0 0 var(--color-black);
            background-color: transparent;
        }

        header nav ul:last-child a:last-child{
            width: 5dvw;
            height: 100%;
            
        }

        header nav ul a:nth-child(2){
            width: auto;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0 0 0 2rem;
        }

        header a img{
            width: auto;
            height: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        main{
            width: 100%;
            height: 93dvh;
            display: grid;
            grid-template-rows: repeat(10, 1fr);
            grid-template-columns: repeat(13, 1fr);
            background-color: var(--color-ghost-white);
            padding: 0;
            margin: 0;
        }

        main img{
            width: 100%;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 2/2/3/7;
        }

        main button{
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--color-yellow);
            text-decoration: none;
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-black);
            font-weight: bold;
            border-radius: 1rem;
            border: 0px;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }


        main button:hover{
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--color-black);
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-yellow);
            font-weight: bold;
            border-radius: 1rem;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        main a{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 5/2/7/5;
            text-decoration: none;
            display: inline-block;
            color: inherit;
        }

        main a button{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 5/2/7/5;
            text-decoration: none;
            display: inline-block;
            color: inherit;
        }

        main input{
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        main label{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 5/6/7/9;
            background-color: var(--color-yellow);
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-black);
            text-align: center;
            font-weight: bold;
            border-radius: 1rem;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        main label span{
            font-size: var(--font-size-sm);
            font-weight: bold;
        }

        main label:hover{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 5/6/7/9;
            background-color: var(--color-black);
            font-family: var(--font-roboto-mono);
            font-size: var(--font-size-sm);
            color: var(--color-yellow);
            text-align: center;
            font-weight: bold;
            border-radius: 1rem;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        main label:hover span{
            font-size: var(--font-size-sm);
            font-weight: bold;
        }

        .button_accion{
            grid-area: 5/10/7/13;
        }

        .span_error{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 8/2/9/13;
            font-size: var(--font-size-sm);
            text-align: center;
            color: var(--color-black);
            font-weight: bold;
        }

        footer{
            width: 100%;
            height: 40dvh;
            display: grid;
            grid-template-rows: repeat(10, 1fr);
            grid-template-columns: repeat(26, 1fr);
            background-color: var(--color-black);

            box-sizing: border-box;
        }

        footer img.img_logo_FI{
            width: auto;
            height: 4dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 9/2/10/4;
        }

        footer a.a_instagram{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 9/25/10/26;
        }

        footer a.a_mail{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 9/24/10/25;
        }

        footer a img{
            width: 2rem;
            height: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        footer a.a_que_es{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            grid-area: 2/2/4/5;
            text-decoration: none;
            font-size: var(--font-size-xsm);
            font-family: var(--font-roboto-mono);
            color: var(--color-ghost-white);
        }

    </style>

</head>
<body>

    <header>
        <nav>
            <ul>
                <a href="index.html"><img src="assets/FI-LOGO-BRUTO-BLACK.svg" alt="LOGO"></a>
            </ul>
            <ul>
                <a href="./index.html">Generador</a>
                <a href="./manual.html">Manual</a>
            </ul>
        </nav>
        
    </header>

    <main>

        <a href="./plantillaDatos.xlsx">
            <button class="button_plantilla" id="button_plantilla">Descargar plantilla</button>
        </a>
        <input class="input_excel" id="input_excel" type="file">
        <label for="input_excel" class="custom-button">
            <span>Seleccionar plantilla</span>
        </label>
        <button class="button_accion" id="button_accion">Generar horarios</button>
        
        <div class="span_error" id="span_error"></div>
    </main>

    <footer>
        <a class="a_que_es" href="./que_es.html">¿Que es FROM SCHEDULE?</a>
        <img class="img_logo_FI" src="./assets/LOGO-FI-BRUTO-YELLOW.png" alt="">
        <a class="a_instagram" href="https://www.instagram.com/fromindustries?igsh=MWRkNHZ6MWI5OWN0Yg=="><img class="img_instagram" src="./assets/logotipo-de-instagram.png" alt=""></a>
        <a class="a_mail" href=""><img class="img_mail" src="./assets/correo-electronico.png" alt=""></a>
    </footer>

    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script>
        const diasSemana = ["lunes", "martes", "miercoles", "jueves", "viernes", "sabado"];
        let MAPA_DOCENTES = new Map(), MAPA_GRUPOS = new Map(), PLANTILLAS_MATERIAS = [], ERRORES = [];

        const esTutoria = (n) => n.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes("TUTORIA");

        class Materia {
            constructor(nombre, horas, grado, turno) {
                this.nombre_materia = nombre; this.horas_materia = parseInt(horas);
                this.grado_materia = grado; this.turno_materia = turno;
                this.docente = null; this.grupo = null; this.desglose_horas = {};
            }

            determinar_horas_clase_por_materia() {
                if (!this.docente) return;
                const tipo = this.docente.tipo_docente;
                const horas = this.horas_materia;
                const cT = this.docente.horas_carga + this.docente.horas_extra_clase;
                const d = this.desglose_horas = {};
                const nm = this.nombre_materia.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

                if (nm.includes("INGLES")) { for (let i = 1; i <= horas; i++) d[`h${i}`] = 1; return; }

                if (tipo === 1 && cT <= 6) {
                    if (horas === 6) { d.h1 = 3; d.h2 = 3; }
                    else if (horas === 5) { d.h1 = 3; d.h2 = 2; }
                    else if (horas === 4) { d.h1 = 2; d.h2 = 2; }
                    else if (horas === 3) { d.h1 = 2; d.h2 = 1; }
                    else if (horas === 2) { d.h1 = 1; d.h2 = 1; } 
                    
                } else if (tipo === 2 && cT < 10) {
                    if (horas === 7) { d.h1 = 4; d.h2 = 3; }
                    else if (horas === 6) { d.h1 = 3; d.h2 = 3; }
                    else if (horas === 5) { d.h1 = 3; d.h2 = 2; }
                    else if (horas === 4) { d.h1 = 2; d.h2 = 2; }
                    else if (horas === 3) { d.h1 = 2; d.h2 = 1; }
                    else if (horas === 2) { d.h1 = 1; d.h2 = 1; }

                } else if (tipo === 1 || (tipo === 2 && cT <= 19)) {
                    if (horas === 7) { d.h1 = 3; d.h2 = 2; d.h3 = 2; }
                    else if (horas === 6) { d.h1 = 2; d.h2 = 2; d.h3 = 2; }
                    else if (horas === 5) { d.h1 = 2; d.h2 = 2; d.h3 = 1; }
                    else if (horas === 4) { d.h1 = 2; d.h2 = 2; }
                    else if (horas === 3) { d.h1 = 2; d.h2 = 1; }
                    else if (horas === 2) { d.h1 = 1; d.h2 = 1; }
                    
                } else if ((tipo === 2 && cT > 19) || tipo === 3 || tipo === 4){ 
                    if (horas === 7) { d.h1 = 2; d.h2 = 2; d.h3 = 2; d.h4 = 1;}
                    else if (horas === 6) { d.h1 = 2; d.h2 = 2; d.h3 = 2; }
                    else if (horas === 5) { d.h1 = 2; d.h2 = 2; d.h3 = 1; }
                    else if (horas === 4) { d.h1 = 2; d.h2 = 2; }
                    else if (horas === 3) { d.h1 = 2; d.h2 = 1; }
                    else if (horas === 2) { d.h1 = 2; }
                }
            }
        }

        class Docente {
            constructor(n, f, t, e) {
                this.nombre_docente = n.trim(); this.fila = f; this.tipo_docente = parseInt(t);
                this.horas_extra_clase = parseInt(e) || 0; this.materias_impartidas = []; this.horas_carga = 0;
                this.reset();
            }
            reset() {
                diasSemana.forEach(d => {
                    this[`lista_${d}`] = this.parseDisp(this.fila[d]);
                    this[`asignado_${d}`] = [];
                });
                this.diasActivosGlobal = new Set();
            }
            parseDisp(s) {
                if (!s || s === "-") return [];
                let h = []; String(s).split(" ").forEach(r => {
                    const [i, f] = r.split("-").map(Number);
                    for (let j = i; j < f; j++) h.push(j);
                }); return h;
            }
        }

        class Grupo {
            constructor(n, t) { this.nombre_grupo = n.trim(); this.turno = t.toLowerCase(); this.materias = []; this.reset(); }
            reset() {
                const b = (this.turno === "matutino") ? [7,8,9,10,11,12,13,14,15,16,17] : [11,12,13,14,15,16,17,18,19,20];
                diasSemana.forEach(d => this[`horario_${d}`] = [...b]);
            }
        }

        document.getElementById("input_excel").onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                MAPA_DOCENTES.clear(); MAPA_GRUPOS.clear(); PLANTILLAS_MATERIAS = [];
                XLSX.utils.sheet_to_json(wb.Sheets["Materias"]).forEach(m => PLANTILLAS_MATERIAS.push(new Materia(m.nombre, m.horas, m.grado, m.turno)));
                XLSX.utils.sheet_to_json(wb.Sheets["Docentes"]).forEach(d => MAPA_DOCENTES.set(d.nombre.trim(), new Docente(d.nombre, d, d.tipo, d['horas extra clase'] || 0)));
                XLSX.utils.sheet_to_json(wb.Sheets["Grupos"]).forEach(g => MAPA_GRUPOS.set(g.nombre.trim(), new Grupo(g.nombre, g.turno)));
                XLSX.utils.sheet_to_json(wb.Sheets["Asignaciones"]).forEach(asig => {
                    const g = MAPA_GRUPOS.get(asig.grupo.trim()), d = MAPA_DOCENTES.get(asig.docente.trim()), p = PLANTILLAS_MATERIAS.find(m => m.nombre_materia === asig.materia);
                    if (g && d && p) {
                        const c = new Materia(p.nombre_materia, p.horas_materia, p.grado_materia, p.turno_materia);
                        c.grupo = g; c.docente = d; g.materias.push(c); d.materias_impartidas.push(c); d.horas_carga += c.horas_materia;
                    }
                });
                document.getElementById("span_error").innerText = "✔ Archivo cargado correctamente.";
            }; reader.readAsArrayBuffer(e.target.files[0]);
        };

        function algoritmoGenerar() {
            ERRORES = [];
            MAPA_GRUPOS.forEach(g => g.reset());
            MAPA_DOCENTES.forEach(d => d.reset());

            const listaOrdenada = Array.from(MAPA_DOCENTES.values()).map(d => {
                const dispTotal = diasSemana.reduce((s, dia) => s + d[`lista_${dia}`].length, 0);
                d.flexibilidad = dispTotal - d.horas_carga;
                return d;
            }).sort((a, b) => {
                if (a.tipo_docente !== b.tipo_docente) return a.tipo_docente - b.tipo_docente;
                return a.flexibilidad - b.flexibilidad;
            });

            console.log("%c--- LISTA DE PRIORIDAD ---", "color:white; background:black; font-weight:bold;");
            console.table(listaOrdenada.map((d, i) => ({ "Orden": i+1, "Docente": d.nombre_docente, "Tipo": d.tipo_docente, "Carga": d.horas_carga+"h", "Flexibilidad": d.flexibilidad+"h" })));

            listaOrdenada.forEach(docente => {
                docente.materias_impartidas.sort((a, b) => esTutoria(a.nombre_materia) - esTutoria(b.nombre_materia));
                docente.materias_impartidas.forEach(materia => {
                    materia.determinar_horas_clase_por_materia();
                    let horasRestantesMateria = materia.horas_materia;
                    let bloquesObjetivo = Object.values(materia.desglose_horas);
                    const esIngles = materia.nombre_materia.toUpperCase().includes("INGLES");

                    while (horasRestantesMateria > 0) {
                        let opciones = [];
                        let maxD = (docente.tipo_docente === 1) ? 6 : (docente.tipo_docente === 2 && docente.horas_carga >= 20 ? 4 : 6);

                        let tamBuscado = bloquesObjetivo.length > 0 ? bloquesObjetivo[0] : 1;
                        if (tamBuscado > horasRestantesMateria) tamBuscado = horasRestantesMateria;

                        diasSemana.forEach(dia => {
                            const hG = materia.grupo[`horario_${dia}`], hD = docente[`lista_${dia}`];
                            if (!docente.diasActivosGlobal.has(dia) && docente.diasActivosGlobal.size >= maxD) return;
                            
                            // FLEXIBILIDAD TIPO 3 Y 4: 
                            // Si el docente es Tipo 3 o 4 y estamos buscando horas sueltas (tamBuscado=1), 
                            // permitimos que repita día para no dejar horas fuera.
                            const puedeRepetirDia = esIngles || ((docente.tipo_docente === 3 || docente.tipo_docente === 4) && tamBuscado === 1);
                            if (!puedeRepetirDia && hG.some(h => typeof h === 'string' && h.includes(materia.nombre_materia))) return;

                            const libres = hG.filter(h => typeof h === 'number' && hD.includes(h));
                            for (let i = 0; i <= libres.length - tamBuscado; i++) {
                                const hSel = libres.slice(i, i + tamBuscado);
                                if (hSel[tamBuscado-1] === hSel[0] + tamBuscado - 1) {
                                    let penalty = (hG.filter(h => typeof h === 'string').length) * 1000;
                                    penalty += (materia.grupo.turno === "vespertino") ? (21 - hSel[tamBuscado-1]) * 10 : hSel[0];
                                    opciones.push({ dia, horas: hSel, penalty, tam: tamBuscado, idxB: 0 });
                                }
                            }
                        });

                        if (opciones.length > 0) {
                            opciones.sort((a, b) => a.penalty - b.penalty);
                            const m = opciones[0];
                            materia.grupo[`horario_${m.dia}`] = materia.grupo[`horario_${m.dia}`].map(h => m.horas.includes(h) ? `${materia.nombre_materia} (${docente.nombre_docente})` : h);
                            docente[`lista_${m.dia}`] = docente[`lista_${m.dia}`].filter(h => !m.horas.includes(h));
                            m.horas.forEach(h => docente[`asignado_${m.dia}`].push({ h, txt: `${materia.nombre_materia} [${materia.grupo.nombre_grupo}]` }));
                            docente.diasActivosGlobal.add(m.dia);
                            horasRestantesMateria -= m.tam;
                            if (bloquesObjetivo.length > 0) {
                                if (m.tam >= bloquesObjetivo[0]) bloquesObjetivo.shift();
                                else bloquesObjetivo[0] -= m.tam;
                            }
                        } else {
                            // FRAGMENTACIÓN AUTOMÁTICA (Prioridad para Tipo 3 y 4)
                            if (bloquesObjetivo.length > 0 && bloquesObjetivo[0] > 1) {
                                let t = bloquesObjetivo.shift();
                                bloquesObjetivo.unshift(1, t - 1);
                                bloquesObjetivo.sort((a,b) => b-a);
                            } else { 
                                // REPORTE DETALLADO DE ERROR
                                const msgError = `D: ${docente.nombre_docente} | G: ${materia.grupo.nombre_grupo} | M: ${materia.nombre_materia}`;
                                ERRORES.push(msgError); 
                                horasRestantesMateria = 0; 
                            }
                        }
                    }
                });
            });
            const errorDiv = document.getElementById("span_error");
            if (ERRORES.length > 0) {
                errorDiv.innerText = "⚠ No asignados:\n" + [...new Set(ERRORES)].join("\n");
                errorDiv.style.color = "#F26649";
            } else {
                errorDiv.innerText = "✔ Horarios generados con éxito.";
                errorDiv.style.color = "green";
            }
        }

        document.getElementById("button_accion").onclick = () => {
            if (MAPA_DOCENTES.size === 0) return alert("Carga datos.");
            algoritmoGenerar();
            const wb = XLSX.utils.book_new();

            MAPA_GRUPOS.forEach(g => {
                const rows = [["HORA", "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"]];
                const base = (g.turno === "matutino") ? [7,8,9,10,11,12,13,14,15,16,17] : [11,12,13,14,15,16,17,18,19,20];
                base.forEach((h, i) => {
                    const r = [h];
                    diasSemana.forEach(d => {
                        const val = g[`horario_${d}`][i];
                        r.push(typeof val === 'string' ? val : "");
                    });
                    rows.push(r);
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "G_" + g.nombre_grupo.substring(0,25));
            });

            MAPA_DOCENTES.forEach(d => {
                const rows = [["HORA", "LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"]];
                for(let h=7; h<=21; h++) {
                    const r = [h];
                    diasSemana.forEach(dia => {
                        const cell = d[`asignado_${dia}`].find(x => x.h === h);
                        r.push(cell ? cell.txt : "");
                    });
                    rows.push(r);
                }
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "D_" + d.nombre_docente.substring(0,25));
            });

            XLSX.writeFile(wb, "Horarios_Flexibles.xlsx");
        };
    </script>
</body>
</html>